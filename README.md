# mlx-monitoring

This is built on top of Marcin Zablocki's Mellanox Monitoring tool:
https://github.com/MarcinZablocki/mlx_monitor/

Usage:
```bash
python3 -m venv mlxmonitoring
source mlxmonitoring/bin/activate
pip3 install tabulate
pip3 install pynvml #For NVIDIA GPUs
pip3 install pyrsmi #For AMD GPUs. Might fail on some OS/Kernel version
pip3 install rich

## For RoCE/Eth (from ethtool statistics):
python3 monitorv2.py
=== NIC Stats (Gbps, Cumulative Drops) ===
NIC               RX History                        RX Gbps    RX Max  TX History                        TX Gbps    TX Max    RX Drop (total)    TX Drop (total)
----------------  ------------------------------  ---------  --------  ------------------------------  ---------  --------  -----------------  -----------------
mlx5_0 (rdma4)    ▃▂▃▆·▄▃▄▃█▄▄·▃▂▄▃▃▃▂▄▃▂▃▄▂▂▂▃▂      25.58     28.33  ▂▂▂▅·▄▃▂▂█▃▄·▃▂▂▃▄▂▂▃▂▂▂▅▂·▂▂·       0.02      0.02                  0                  0
mlx5_1 (rdma5)    ·▅·▇·····▇▅····▇······█·····▇·       0         0     ······························       0         0                     0                  0
mlx5_10 (rdma12)  ▆▄·▆▃▅█·▇▆▅▃▅▅▆▂▄▃▄▄▄▃▆▆▆▂▂▅▆▄      26.34     27.51  ▇▄·▇▃▆▄·▆█▅▃▅▅▆▂▆▇▃▅▄▃▅▄▇▄▂▅▅▃       0.02      0.02                  0                  0
mlx5_11 (rdma13)  ·▅·▇····▇·▅····▇······█·····▇·       0         0     ······························       0         0                     0                  0
mlx5_12 (rdma14)  ·▅·▇····▇·▅···▇······█······▇·       0         0     ······························       0         0                     0                  0
mlx5_13 (rdma15)  ·▅▇·····▇·▅···▇······█·····▇··       0         0     ······························       0         0                     0                  0
mlx5_14 (rdma8)   ▄▄▂▆▃▆▃·▇█▃▆▂▃·▃▄▅▂▅▂▄▂▂▄▄▃▃▃▂      25.37     27.1   ▃▂▃▅▃▅▃·▆█▃▅▂▄▂·▄▄▂▄▂▄·▃▅▃·▃▂▂       0.02      0.02                  0                  0
mlx5_15 (rdma9)   ·▅▇·····▇·▅···▇······█·····▇··       0         0     ······························       0         0                     0                  0
mlx5_16 (rdma10)  ·▅▇····▇··▅···▇·····█······▇··       0         0     ······························       0         0                     0                  0
mlx5_17 (rdma11)  ·█·····▅··▃··▅······▅······▅··       0         0     ······························       0         0                     0                  0
mlx5_2 (rdma6)    ·█·····▅··▃··▅······▅·····▅···       0         0     ······························       0         0                     0                  0
mlx5_3 (rdma7)    ·█·····▅··▃··▅······▅·····▅···       0         0     ······························       0         0                     0                  0
mlx5_4 (eth0)     ············▃▅··█▂············       0         0     ▃·····▂······▂·▂█·▃····▂···▂··       0         0                     0                  0
mlx5_6 (rdma0)    ▄▄▃▅▅▅▅▄█▆▄▆▃▄▄▄·▃▅▃▃▄▄▅▄▃·▆▃·      25.21     27.41  ▅▅▄▅▅▆▅▄█▆▅▅▄▄▄▅▃▄▅▅▄▆▅▄▇▃·▅▂▂       0.02      0.02                  0                  0
mlx5_7 (rdma1)    ·█····▅··▃···▅·····▅······▅···       0         0     ······························       0         0                     0                  0
mlx5_8 (rdma2)    ▇▅····▇·····█······▇·····▇····       0         0     ·········█····················       0         0                     0                  0
mlx5_9 (rdma3)    ▇▅····▇··▅··█······▇·····▇····       0         0     ······························       0         0                     0                  0

=== RDMA NIC traffic classes per-Priority Bandwidth (Gbps) ===
NIC                   RX P0    RX P1    RX P2    RX P3    RX P4    RX P5    RX P6    RX P7    TX P0    TX P1    TX P2    TX P3    TX P4    TX P5    TX P6    TX P7    TOTAL RX    TOTAL TX
------------------  -------  -------  -------  -------  -------  -------  -------  -------  -------  -------  -------  -------  -------  -------  -------  -------  ----------  ----------
mlx5_0:1 (rdma4)      25.82        0        0        0        0        0        0        0     0.02        0        0        0        0        0        0        0       25.82        0.02
mlx5_1:1 (rdma5)       0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_10:1 (rdma12)    25.36        0        0        0        0        0        0        0     0.02        0        0        0        0        0        0        0       25.36        0.02
mlx5_11:1 (rdma13)     0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_12:1 (rdma14)     0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_13:1 (rdma15)     0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_14:1 (rdma8)     24.73        0        0        0        0        0        0        0     0.02        0        0        0        0        0        0        0       24.73        0.02
mlx5_15:1 (rdma9)      0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_16:1 (rdma10)     0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_17:1 (rdma11)     0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_2:1 (rdma6)       0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_3:1 (rdma7)       0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_6:1 (rdma0)      25.49        0        0        0        0        0        0        0     0.02        0        0        0        0        0        0        0       25.49        0.02
mlx5_7:1 (rdma1)       0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_8:1 (rdma2)       0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0
mlx5_9:1 (rdma3)       0           0        0        0        0        0        0        0     0           0        0        0        0        0        0        0        0           0

=== GPU Stats ===
GPU    Util History                      Util %    Util Max  Mem History                       Mem %    Mem Max  Temp    Power        Graphics Freq    Memory Freq
-----  ------------------------------  --------  ----------  ------------------------------  -------  ---------  ------  -----------  ---------------  -------------
GPU-0  ······························         0           0  ······························      5.9        5.9  39C     107W / 400W  1410 MHz         1215 MHz
GPU-1  ······························         0           0  ······························      0.8        0.8  37C     104W / 400W  1410 MHz         1215 MHz
GPU-2  ······························         0           0  ······························      0.8        0.8  39C     108W / 400W  1410 MHz         1215 MHz
GPU-3  ······························         0           0  ······························      0.8        0.8  39C     106W / 400W  1410 MHz         1215 MHz
GPU-4  ······························         0           0  ······························      0.8        0.8  39C     100W / 400W  1410 MHz         1215 MHz
GPU-5  ······························         0           0  ······························      0.8        0.8  37C     105W / 400W  1410 MHz         1215 MHz
GPU-6  ······························         0           0  ······························      0.8        0.8  39C     104W / 400W  1410 MHz         1215 MHz
GPU-7  ······························         0           0  ······························      0.8        0.8  40C     104W / 400W  1410 MHz         1215 MHz


#For Infiniband (this takes stats from infiniband counters)
 python3 monitorv2.py --ib
=== InfiniBand Fabric Port Counters ===
IB Port      TX Packets    RX Packets    TX Gbps    RX Gbps    TX Max    RX Max    TX Discards    RX Errors    Symbol Errors    Link Downs    Link Recovery
---------  ------------  ------------  ---------  ---------  --------  --------  -------------  -----------  ---------------  ------------  ---------------
mlx5_0:1     3603826215   56805952127       0.02      25.73      0.03     30.29              0            0                0             0                0
mlx5_1:1              0             0       0          0         0         0                 0            0                0             0                0
mlx5_10:1    3572287593   56387846749       0.02      26.25      0.03     30.41              0            0                0             0                0
mlx5_11:1             0             0       0          0         0         0                 0            0                0             0                0
mlx5_12:1             0             0       0          0         0         0                 0            0                0             0                0
mlx5_13:1             0             0       0          0         0         0                 0            0                0             0                0
mlx5_14:1    3577618464   56401099663       0.02      25.8       0.03     28.46              0            0                0             0                0
mlx5_15:1             0             0       0          0         0         0                 0            0                0             0                0
mlx5_16:1             0             0       0          0         0         0                 0            0                0             0                0
mlx5_17:1             0             0       0          0         0         0                 0            0                0             0                0
mlx5_2:1              0             0       0          0         0         0                 0            0                0             0                0
mlx5_3:1              0             0       0          0         0         0                 0            0                0             0                0
mlx5_4:1              0             0       0          0         0         0                 0            0                0             0                0
mlx5_6:1     3569674996   56296631879       0.02      25.72      0.03     29.71              0            0                0             0                0
mlx5_7:1              0             0       0          0         0         0                 0            0                0             0                0
mlx5_8:1              0             0       0          0         0         0                 0            0                0             0                0
mlx5_9:1              0             0       0          0         0         0                 0            0                0             0                0

=== GPU Stats ===
GPU    Util History                      Util %    Util Max  Mem History                       Mem %    Mem Max  Temp    Power        Graphics Freq    Memory Freq
-----  ------------------------------  --------  ----------  ------------------------------  -------  ---------  ------  -----------  ---------------  -------------
GPU-0  ······························         0           1  ······························      5.9       11    39C     107W / 400W  1410 MHz         1215 MHz
GPU-1  ······························         0           0  ······························      0.8        0.8  37C     104W / 400W  1410 MHz         1215 MHz
GPU-2  ······························         0           0  ······························      0.8        0.8  39C     108W / 400W  1410 MHz         1215 MHz
GPU-3  ······························         0           0  ······························      0.8        0.8  39C     106W / 400W  1410 MHz         1215 MHz
GPU-4  ······························         0           0  ······························      0.8        0.8  39C     101W / 400W  1410 MHz         1215 MHz
GPU-5  ······························         0           0  ······························      0.8        0.8  37C     105W / 400W  1410 MHz         1215 MHz
GPU-6  ······························         0           0  ······························      0.8        0.8  39C     104W / 400W  1410 MHz         1215 MHz
GPU-7  ······························         0           0  ······························      0.8        0.8  40C     104W / 400W  1410 MHz         1215 MHz



#To dump stats to a csv file
python3 monitorv2.py --dump
##or
python3 monitorv2.py --ib --dump
